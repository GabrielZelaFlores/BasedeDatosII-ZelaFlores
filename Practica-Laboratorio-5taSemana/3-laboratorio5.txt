-- Paso 1.3: Transacción de pedido e-commerce
-- 1.3.1 Crear un pedido completo
BEGIN;
    -- Ver inventario inicial
    SELECT id, nombre, precio, stock FROM productos WHERE id IN (1, 2, 3);
    -- PEDIDO: Cliente compra 1 Laptop + 2 Mouse + 1 Teclado
    INSERT INTO pedidos (cliente_nombre, cliente_email, estado)
    VALUES ('Roberto Silva', 'roberto@email.com', 'PROCESANDO');
    -- Obtener el ID del pedido recién creado
    -- En PostgreSQL, podemos usar RETURNING o variables
    -- Método alternativo más claro
    END;
BEGIN;
    -- Reiniciemos con un enfoque más didáctico:
    -- 1. Verificar stock disponible ANTES de procesar
    SELECT nombre, stock FROM productos WHERE id IN (1, 2, 3);
    -- 2. Crear el pedido
    INSERT INTO pedidos (cliente_nombre, cliente_email, estado)
    VALUES ('Roberto Silva', 'roberto@email.com', 'PROCESANDO');
    -- 3. Obtener el ID del pedido (para simplificar, asumimos que es el último)
    -- En práctica real usarían RETURNING o variables
    -- 4. Agregar detalles del pedido y actualizar inventario
    INSERT INTO detalle_pedidos (pedido_id, producto_id, cantidad, precio_unitario, subtotal)
    VALUES (1, 1, 1, 2500.00, 2500.00);
    INSERT INTO detalle_pedidos (pedido_id, producto_id, cantidad, precio_unitario, subtotal)
    VALUES (1, 2, 2, 45.00, 90.00);
    INSERT INTO detalle_pedidos (pedido_id, producto_id, cantidad, precio_unitario, subtotal)
    VALUES (1, 3, 1, 180.00, 180.00);
    -- Actualizar stock
    UPDATE productos SET stock = stock - 1 WHERE id = 1;
    UPDATE productos SET stock = stock - 2 WHERE id = 2;
    UPDATE productos SET stock = stock - 1 WHERE id = 3;
    -- 5. Calcular y actualizar el total del pedido
    UPDATE pedidos SET total = (SELECT SUM(subtotal) FROM detalle_pedidos WHERE pedido_id = 1),
                      estado = 'CONFIRMADO'
    WHERE id = 1;
    -- Verificar el estado antes del commit
    SELECT * FROM pedidos WHERE id = 1
    UNION ALL
    SELECT 'STOCK', id, nombre, stock::text, '' FROM productos WHERE id IN (1, 2, 3);
COMMIT;
    -- Verificar estado final
    SELECT * FROM pedidos WHERE id = 1;
    SELECT id, nombre, stock FROM productos WHERE id IN (1, 2, 3);